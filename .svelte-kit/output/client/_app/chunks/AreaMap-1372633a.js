import{W as e,_ as a,$ as t,S as o,i as r,s,e as n,c as l,a as i,d as c,b as d,I as u,f as h,E as g,L as p,M as y,a0 as f,z as m,a1 as w,P as b,a2 as v}from"./vendor-718580ba.js";import{c as S,e as M,r as L,d as P,s as x,f as j,m as $,a as _,b as k,l as C,g as F,h as I,i as z,j as E}from"./mapstore-48813ed6.js";var T={};let Z=[];async function q(){e(S).addSource("drawsrc",{type:"geojson",data:{type:"Feature",geometry:{type:"Polygon",coordinates:[]}}}),e(S).addLayer({id:"draw_layer",type:"line",source:"drawsrc",paint:{"line-color":"#222","line-width":5,"line-dasharray":[2,1]}}),e(S).addLayer({id:"circle_layer",type:"circle",source:"drawsrc",paint:{"circle-radius":{base:2,stops:[[0,0],[22,180]]},"circle-color":"coral","circle-opacity":.5}}),M.subscribe((()=>{Z=[],A(D="radius"!=e(M))})),M.set("radius"),L.subscribe(A),e(S).on("click","bounds",(function(t){switch(console.log(t.lngLat,e(M)),e(M)){case"radius":!function(a,t=20){for(var o,r,s,n={latitude:a.lat,longitude:a.lng},l=e(L)/2,i=[],c=l/(111.32*Math.cos(n.latitude*Math.PI/180)),d=l/110.574,u=0;u<t;u++)o=u/t*(2*Math.PI),r=c*Math.cos(o),s=d*Math.sin(o),i.push([n.longitude+r,n.latitude+s]);i.push(i[0]),R(i)}(t.lngLat);break;case"poly":!function(a){if(Z.length&&function(a,t,o=30){return a=e(S).project(a),t=e(S).project(t),Math.sqrt((a.x-t.x)**2+(a.y-t.y)**2)<o}(Z[0],[a.lng,a.lat]))return Z.push(Z[0]),R(Z),console.log("--saving polygon",e(x)),Z=[],D(),1;Z.push([a.lng,a.lat]);var t={type:"Feature",geometry:{type:"Polygon",coordinates:[Z]}};console.error(t),O("drawsrc",t)}(t.lngLat);break;case"click":!function(t){const o=new Set(t.features.map((e=>e.properties.oa))),r=e(x);var s=Object.assign({},r[r.length-1]);s.lat.push(t.lngLat.lat),s.lng.push(t.lngLat.lng),s={oa:new Set(s.oa),lat:a(s.lat),lng:a(s.lng)},[...o].forEach((e=>s.oa.has(e)?s.oa.delete(e):s.oa.add(e))),r.push(s),x.set(r)}(t)}})),e(S).on("zoomend",(function(){P.set(e(S).getZoom()<10)})),e(S).on("mousemove","bounds",(function(a){switch(e(M)){case"radius":t=a.lngLat,O("drawsrc",{type:"Feature",geometry:{type:"Point",coordinates:[t.lng,t.lat]}});break;case"poly":!function(e){O("drawsrc",{type:"Feature",geometry:{type:"Polygon",coordinates:[[...Z,[e.lng,e.lat]]]}})}(a.lngLat)}var t}))}function D(){O("drawsrc",{type:"Feature",geometry:{type:"Polygon",coordinates:[]}})}function O(a,t){e(S).getSource(a).setData(t)}function R(t){const o=(s=(r=t).map((e=>e[1])),n=r.map((e=>e[0])),l=[Math.min.apply(null,n),Math.min.apply(null,s)],i=[Math.max.apply(null,n),Math.max.apply(null,s)],[l,i]);var r,s,n,l,i;const c=e(S).queryRenderedFeatures(o.map((a=>e(S).project(a))),{layers:["centroids"]}).filter((e=>function(e,a){if(!e.length)return!1;for(var t,o,r=e.length,s=e[r-1],[n,l]=a,[i,c]=s,d=!1,u=0;u<r;++u)t=(s=e[u])[0],(o=s[1])>l!=c>l&&n<(i-t)*(l-o)/(c-o)+t&&(d=!d),i=t,c=o;return d}(t,e.geometry.coordinates))).map((e=>e.properties.id));var d=e(x),u=d[d.length-1];o.map((e=>{u.lat.push(e[1]),u.lng.push(e[0])})),e(j)?d.push({oa:new Set([...u.oa,...c]),lng:a(u.lng),lat:a(u.lat)}):d.push({oa:new Set([...u.oa].filter((e=>!new Set(c).has(e)))),lng:a(u.lng),lat:a(u.lat)}),x.set(d),console.warn("updated---",e(x),e(j))}function A(a=!1){if(console.warn("-circle",a),S){if(1==a)return e(S).setPaintProperty("circle_layer","circle-radius",5);const t=(e,a)=>e/.075/Math.cos(a*Math.PI/180);e(S).setPaintProperty("circle_layer","circle-radius",{base:2,stops:[[0,0],[22,t(2e3*e(L),e(S).getCenter().lat)]]})}}async function B(){const a=e(x)[e(x).length-1],o=[a.lng[0],a.lat[0],a.lng[1],a.lat[1]],[r,s,n]=t.bboxToTile(o);if(28===n)return null;var l=`${n}/${r}/${s}`;if(n<7)return{error_title:"Total area selected exceeds allowed limit. Please use the undo button to reduce area size.",error:`Parent Data Tile ${l}`};if(T[l])var i=T[l];else(i=await fetch(`http://localhost:7113/encoding/${l}.json`).then((e=>e.json()))).lsoa=i.lsoa.map((e=>(e[1]=new Set(e[1]),e))),i.msoa=i.msoa.map((e=>(e[1]=new Set(e[1]),e))),T[l]=i;var c=[],d=a.oa,u=i.lsoa.filter((e=>![...e[1]].filter((e=>!d.has(e))).length));u=new Set(u.map((e=>(c.push([...e[1]]),e[0]))));var h=i.msoa.filter((e=>![...e[1]].filter((e=>!u.has(e))).length));c=new Set(c.flat());var g=new Set(h.map((e=>e[1])).flat());return d=[...d].filter((e=>!c.has(e))),u=[...u].filter((e=>!g.has(e))),{tile:l,msoa:h=h.map((e=>e[0])),oa:d,lsoa:u,original:[...a.oa].length}}function N(e){let a,t;return{c(){a=n("main"),t=n("div"),this.h()},l(e){a=l(e,"MAIN",{class:!0});var o=i(a);t=l(o,"DIV",{class:!0,tabindex:!0,"aria-label":!0,id:!0,style:!0}),i(t).forEach(c),o.forEach(c),this.h()},h(){d(t,"class","mapboxgl-canvas"),d(t,"tabindex","0"),d(t,"aria-label","Map"),d(t,"id","mapcontainer"),u(t,"width",e[0]),u(t,"height",e[1]),u(t,"opacity",(e[2]?.4:1)+" "),d(a,"class","svelte-2r8wq7")},m(o,r){h(o,a,r),g(a,t),e[6](t)},p(e,[a]){1&a&&u(t,"width",e[0]),2&a&&u(t,"height",e[1]),4&a&&u(t,"opacity",(e[2]?.4:1)+" ")},i:p,o:p,d(t){t&&c(a),e[6](null)}}}function V(e,a,t){let o,r,s,n,l;y(e,S,(e=>t(7,o=e))),y(e,$,(e=>t(8,r=e))),y(e,_,(e=>t(9,s=e))),y(e,k,(e=>t(10,n=e))),y(e,M,(e=>t(11,l=e))),f();var i=!0;const c=v;let d,{drawing_tools:u=!1}=a,{width:h="100vw"}=a,{height:g="100vh"}=a;async function p(){console.log("set layers"),$.subscribe((async()=>{for(const[e,a]of Object.entries(r))o.getSource(e)&&o.removeSource(e),o.getSource(e)||o.addSource(e,a)})),_.subscribe((async()=>{for(const e of s)console.log("layer",e),o.getLayer(e.id)&&o.removeLayer(e.id),o.addLayer(e)})),k.subscribe((async()=>{for(const e of n)e.off||console.log("adding",e.event,e.layer),o.on(e.event,e.layer,e.callback)})),u&&await q(),o.fitBounds(C.bounds,{padding:20}),M.subscribe((()=>{console.warn("------dt-------",l)})),t(2,i=!1),console.warn("---loaded---")}return m((async function(){console.warn(d),b(S,o=new c.Map({container:"mapcontainer",style:F,minZoom:I,maxZoom:z,maxBounds:E,pitch:10,center:[0,52],zoom:4,hash:!0}),o),o.addControl(new c.ScaleControl({position:"bottom-left"})),o.addControl(new c.NavigationControl,"bottom-right"),o.doubleClickZoom.disable(),o.dragRotate.disable(),o.on("error",(e=>{if(403!=e.error.status&&"Failed to fetch"!=e.error.message&&!/CORS/.test(e.error.message))return console.error("--",e.error.status,e.error.message),e})),o.on("load",p)})),e.$$set=e=>{"drawing_tools"in e&&t(4,u=e.drawing_tools),"width"in e&&t(0,h=e.width),"height"in e&&t(1,g=e.height)},[h,g,i,d,u,p,function(e){w[e?"unshift":"push"]((()=>{d=e,t(3,d)}))}]}class W extends o{constructor(e){super(),r(this,e,V,N,s,{drawing_tools:4,width:0,height:1,SetLayers:5})}get SetLayers(){return this.$$.ctx[5]}}export{W as A,B as s};
