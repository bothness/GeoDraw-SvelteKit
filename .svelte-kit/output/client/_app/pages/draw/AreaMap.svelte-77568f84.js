import{T as e,S as a,i as t,s as o,e as s,c as r,a as n,d as c,b as i,I as l,f as d,E as u,L as p,M as h,X as g,z as y,Y as f,O as m,Z as w}from"../../chunks/vendor-4d3c3715.js";import{d as b,r as v,s as S,c as M,e as k,m as L,a as x,b as j,l as P,f as F,g as C,h as _,i as I}from"../../chunks/mapstore-75392c4b.js";let E=[];async function B(){e(M).addSource("drawsrc",{type:"geojson",data:{type:"Feature",geometry:{type:"Polygon",coordinates:[]}}}),e(M).addLayer({id:"draw_layer",type:"line",source:"drawsrc",paint:{"line-color":"#222","line-width":5,"line-dasharray":[2,1]}}),e(M).addLayer({id:"circle_layer",type:"circle",source:"drawsrc",paint:{"circle-radius":{base:2,stops:[[0,0],[22,180]]},"circle-color":"coral","circle-opacity":.5}}),b.set("radius"),b.subscribe((()=>E=[])),v.subscribe(z),e(M).on("click","bounds",(function(a){switch(console.log(a.lngLat,e(b)),console.warn(a.features[0].properties),e(b)){case"radius":!function(a,t=20){var o={latitude:a.lat,longitude:a.lng};O();for(var s,r,n,c=e(v),i=[],l=c/(111.32*Math.cos(o.latitude*Math.PI/180)),d=c/110.574,u=0;u<t;u++)s=u/t*(2*Math.PI),r=l*Math.cos(s),n=d*Math.sin(s),i.push([o.longitude+r,o.latitude+n]);i.push(i[0]),e(M).panTo(a);const p=$(i);e(M).fitBounds(p);const h=e(M).queryRenderedFeatures(p.map((a=>e(M).project(a))),{layers:["centroids"]}),g=q(h,i);console.log(g,h),Z(g.get(1)||[],g.get(0)||[])}(a.lngLat);break;case"poly":!function(a){if(E.length&&function(a,t,o=30){return a=e(M).project(a),t=e(M).project(t),Math.sqrt((a.x-t.x)**2+(a.y-t.y)**2)<o}(E[0],[a.lng,a.lat])){E.push(E[0]);const a=$(E);e(M).fitBounds(a);const t=q(e(M).queryRenderedFeatures(a.map((a=>e(M).project(a))),{layers:["centroids"]}),E);return Z(t.get(1)||[],t.get(0)||[]),console.log("--saving polygon",t),E=[],O(),1}E.push([a.lng,a.lat]),console.log(E);var t={type:"Feature",geometry:{type:"Polygon",coordinates:[E]}};console.error(t),R("drawsrc",t)}(a.lngLat);break;case"click":!function(a){(function(a){const t=e(S);var o=Object.assign({},t[t.length-1]);o={oa:new Set(o.oa),msoa:new Set(o.msoa)},console.log("--clicked",a,o),[...a].forEach((e=>o.oa.has(e)?o.oa.delete(e):o.oa.add(e))),console.log(o.oa),t.push(o),S.set(t)})(new Set(a.features.map((e=>e.properties.oa)))),console.warn("--clickadd",e(S))}(a)}})),e(M).on("mousemove","bounds",(function(a){switch(e(b)){case"radius":t=a.lngLat,R("drawsrc",{type:"Feature",geometry:{type:"Point",coordinates:[t.lng,t.lat]}});break;case"poly":!function(e){R("drawsrc",{type:"Feature",geometry:{type:"Polygon",coordinates:[[...E,[e.lng,e.lat]]]}})}(a.lngLat)}var t}))}function O(){R("drawsrc",{type:"Feature",geometry:{type:"Polygon",coordinates:[]}})}function R(a,t){e(M).getSource(a).setData(t)}function Z(a=[],t=[]){var o=e(S),s=o[o.length-1];e(k)?o.push({oa:new Set([...s.oa,...a]),msoa:new Set([...s.msoa,...t])}):o.push({oa:new Set([...s.oa].filter((e=>!new Set(a).has(e)))),msoa:new Set([...s.msoa].filter((e=>!new Set(t).has(e))))}),S.set(o),console.warn("updated---",e(S),e(k))}function $(e){var a=e.map((e=>e[1])),t=e.map((e=>e[0]));return[[Math.min.apply(null,t),Math.min.apply(null,a)],[Math.max.apply(null,t),Math.max.apply(null,a)]]}function q(e,a){const t=e.filter((e=>function(e,a){if(!e.length)return!1;for(var t,o,s=e.length,r=e[s-1],[n,c]=a,[i,l]=r,d=!1,u=0;u<s;++u)t=(r=e[u])[0],(o=r[1])>c!=l>c&&n<(i-t)*(c-o)/(l-o)+t&&(d=!d),i=t,l=o;return d}(a,e.geometry.coordinates))),o=new Map(Array.from(t,(e=>[e.properties.k,[]])));return t.forEach((e=>o.get(e.properties.k).push(e.properties.id))),o}function z(){if(M){const a=(e,a)=>e/.075/Math.cos(a*Math.PI/180);e(M).setPaintProperty("circle_layer","circle-radius",{base:2,stops:[[0,0],[22,a(2e3*e(v),e(M).getCenter().lat)]]})}}function A(e){let a,t;return{c(){a=s("main"),t=s("div"),this.h()},l(e){a=r(e,"MAIN",{class:!0});var o=n(a);t=r(o,"DIV",{class:!0,tabindex:!0,"aria-label":!0,id:!0,style:!0}),n(t).forEach(c),o.forEach(c),this.h()},h(){i(t,"class","mapboxgl-canvas"),i(t,"tabindex","0"),i(t,"aria-label","Map"),i(t,"id","mapcontainer"),l(t,"width",e[0]),l(t,"height",e[1]),i(a,"class","svelte-16o3juj")},m(o,s){d(o,a,s),u(a,t),e[5](t)},p(e,[a]){1&a&&l(t,"width",e[0]),2&a&&l(t,"height",e[1])},i:p,o:p,d(t){t&&c(a),e[5](null)}}}function D(e,a,t){let o,s,r,n,c;h(e,M,(e=>t(6,o=e))),h(e,L,(e=>t(7,s=e))),h(e,x,(e=>t(8,r=e))),h(e,j,(e=>t(9,n=e))),h(e,b,(e=>t(10,c=e))),g();const i=w;let l,{drawing_tools:d=!1}=a,{width:u="100vw"}=a,{height:p="100vh"}=a;async function v(){console.log("set layers"),L.subscribe((async()=>{for(const[e,a]of Object.entries(s))o.getSource(e)&&o.removeSource(e),o.getSource(e)||o.addSource(e,a)})),x.subscribe((async()=>{for(const e of r)console.log("layer",e),o.getLayer(e.id)&&o.removeLayer(e.id),o.addLayer(e)})),j.subscribe((async()=>{for(const e of n)e.off||console.log("adding",e.event,e.layer),o.on(e.event,e.layer,e.callback)})),d&&await B(),o.fitBounds(P.bounds,{padding:20})}return b.subscribe((()=>{console.warn("------dt-------",c)})),y((async function(){console.warn(l),m(M,o=new i.Map({container:"mapcontainer",style:F,minZoom:C,maxZoom:_,maxBounds:I,pitch:10,center:[0,52],zoom:4,hash:!0}),o),o.addControl(new i.ScaleControl({position:"bottom-left"})),o.addControl(new i.NavigationControl,"bottom-right"),o.doubleClickZoom.disable(),o.dragRotate.disable(),o.on("error",(e=>{if(403!=e.error.status&&"Failed to fetch"!=e.error.message&&!/CORS/.test(e.error.message))return console.error(e.error.status,e.error.message),e})),o.on("load",v)})),e.$$set=e=>{"drawing_tools"in e&&t(3,d=e.drawing_tools),"width"in e&&t(0,u=e.width),"height"in e&&t(1,p=e.height)},[u,p,l,d,v,function(e){f[e?"unshift":"push"]((()=>{l=e,t(2,l)}))}]}export default class extends a{constructor(e){super(),t(this,e,D,A,o,{drawing_tools:3,width:0,height:1,SetLayers:4})}get SetLayers(){return this.$$.ctx[4]}}
